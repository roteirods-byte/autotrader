# worker.py — agenda heartbeat e mantém o processo vivo

import time
import sys
import traceback
from apscheduler.schedulers.background import BackgroundScheduler
from db import create_tables, heartbeat

def beat():
    try:
        heartbeat("worker", "alive")
    except Exception as e:
        # Não derruba o processo; apenas loga
        print("beat ERROR:", e, flush=True)
        traceback.print_exc(file=sys.stdout)

def main():
    try:
        create_tables()
    except Exception as e:
        # Mesmo se falhar criar/validar, segue rodando e tenta no próximo ciclo
        print("create_tables ERROR:", e, flush=True)
        traceback.print_exc(file=sys.stdout)

    sch = BackgroundScheduler(timezone="UTC", daemon=False)
    sch.add_job(
        beat,
        "interval",
        seconds=60,
        id="heartbeat",
        replace_existing=True,
        max_instances=1,
        misfire_grace_time=30,
    )
    sch.start()

    # Mantém o processo vivo para o Render não reiniciar o worker
    while True:
        time.sleep(30)

if __name__ == "__main__":
    main()
